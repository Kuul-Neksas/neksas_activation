<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Attivazione NeksÉ™s</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 900px; margin: 24px auto; }
    .box { border: 1px solid #ddd; padding: 16px; border-radius: 8px; margin-bottom: 16px; }
    button { padding: 8px 12px; margin: 4px; }
    label { display: block; margin: 6px 0; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .hidden { display: none; }
  </style>
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h2>Attiva il servizio NeksÉ™s</h2>

  <div id="auth" class="box">
    <h3>Accedi o registrati</h3>
    <p>Scegli un provider:</p>
    <div>
      <button onclick="oauth('email')">Email link</button>
      <button onclick="oauth('google')">Google</button>
      <button onclick="oauth('apple')">Apple</button>
      <button onclick="oauth('github')">GitHub</button>
      <button onclick="oauth('linkedin')">LinkedIn</button>
      <button onclick="oauth('facebook')">Facebook</button>
    </div>
    <div id="emailBox" class="hidden">
      <input id="emailInput" type="email" placeholder="tua@email.it" />
      <button onclick="magicLink()">Invia magic link</button>
    </div>
  </div>

  <div id="formBox" class="box hidden">
    <h3>Dati utente</h3>
    <div class="grid">
      <label>Nome <input id="first_name" /></label>
      <label>Cognome <input id="last_name" /></label>
      <label>Azienda <input id="company" /></label>
      <label>P. IVA <input id="vat_number" /></label>
      <label>Telefono <input id="phone" /></label>
      <label>Email <input id="email" disabled /></label>
    </div>

    <h3 style="margin-top:18px;">Seleziona PSP e circuiti</h3>
    <div id="psps"></div>

    <button id="submitBtn" onclick="submitActivation()">Crea/aggiorna e attiva</button>
    <div id="msg"></div>
  </div>

  <script>
    const SUPABASE_URL = "{{ supabase_url }}";
    const SUPABASE_ANON_KEY = "{{ supabase_anon_key }}";
    const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let session = null;

    async function init() {
      const { data } = await supa.auth.getSession();
      session = data.session;
      if (session) {
        document.getElementById('auth').classList.add('hidden');
        document.getElementById('formBox').classList.remove('hidden');
        document.getElementById('email').value = session.user.email || '';
        await loadPSPs();
      }
    }

    async function loadPSPs() {
      const res = await fetch('/api/psps');
      const psps = await res.json();
      const container = document.getElementById('psps');
      container.innerHTML = '';
      const circuits = ['Visa','Mastercard','Amex','Diners'];
      psps.forEach(p => {
        const div = document.createElement('div');
        div.className = 'box';
        div.innerHTML = `<strong>${p.psp_name}</strong> <small>(default: â‚¬${p.fixed_fee.toFixed(2)} + ${p.percentage_fee}% ${p.currency})</small>`;
        circuits.forEach(c => {
          const id = `${p.id}|${c}`;
          div.innerHTML += `<label><input type="checkbox" value="${id}"> ${c}</label>`;
        });
        container.appendChild(div);
      });
    }

    async function oauth(provider) {
      if (provider === 'email') {
        document.getElementById('emailBox').classList.remove('hidden');
        return;
      }
      await supa.auth.signInWithOAuth({
        provider,
        options: { redirectTo: window.location.origin + '/activate' }
      });
    }

    async function magicLink() {
      const email = document.getElementById('emailInput').value.trim();
      if (!email) return alert('Inserisci una email');
      const { error } = await supa.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.origin + '/activate' }});
      if (error) return alert('Errore: ' + error.message);
      alert('Controlla la tua email per il link di accesso');
    }

    async function submitActivation() {
      const { data } = await supa.auth.getSession();
      if (!data.session) return alert('Devi essere autenticato');
      const token = data.session.access_token;

      const selections = Array.from(document.querySelectorAll('#psps input[type="checkbox"]:checked'))
        .map(i => {
          const [psp_id, circuit] = i.value.split('|');
          return { psp_id, circuit };
        });

      const payload = {
        profile: {
          first_name: document.getElementById('first_name').value,
          last_name: document.getElementById('last_name').value,
          company: document.getElementById('company').value,
          vat_number: document.getElementById('vat_number').value,
          phone: document.getElementById('phone').value
        },
        selections
      };

      const res = await fetch('/api/activate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify(payload)
      });

      const out = await res.json();
      document.getElementById('msg').textContent = res.ok ? 'Attivazione completata ðŸŽ‰' : ('Errore: ' + (out.error || ''));
    }

    init();
  </script>
</body>
</html>
