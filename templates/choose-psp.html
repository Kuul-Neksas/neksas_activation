<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Registrazione e Scelta PSP</title>
</head>
<body>
  <h2>Completa il tuo profilo</h2>
  <form id="user-form">
    <label for="name">Nome:</label>
    <input type="text" id="name" required><br>

    <label for="surname">Cognome:</label>
    <input type="text" id="surname" required><br>

    <label for="business_name">Ragione Sociale:</label>
    <input type="text" id="business_name" required><br>

    <label>Seleziona i PSP da attivare:</label><br>
    <input type="checkbox" name="psp" value="nexi"> Nexi<br>
    <input type="checkbox" name="psp" value="stripe"> Stripe<br>
    <input type="checkbox" name="psp" value="paypal"> PayPal<br>
    <input type="checkbox" name="psp" value="satispay"> Satispay<br><br>

    <button type="submit">Conferma</button>
  </form>

  <script>
    const sbClient = supabase.createClient(
      "{{ supabase_url }}",
      "{{ supabase_anon_key }}"
    );

    async function handleUserDataSubmit(event) {
      event.preventDefault();

      const email = new URLSearchParams(window.location.search).get("email");
      const name = document.getElementById("name").value.trim();
      const surname = document.getElementById("surname").value.trim();
      const businessName = document.getElementById("business_name").value.trim();
      const selectedPSPs = Array.from(document.querySelectorAll('input[name="psp"]:checked')).map(el => el.value);

      const { data: authUser, error: authError } = await sbClient
        .from('auth.users')
        .select('id')
        .eq('email', email)
        .single();

      if (authError || !authUser) {
        alert("Errore nel recupero dell'utente autenticato.");
        return;
      }

      const userId = authUser.id;

      // Inserimento in users
      await sbClient.from('users').insert([
        {
          id: userId,
          email,
          name,
          surname,
          business_name: businessName,
          is_active: true
        }
      ]);

      // Inserimento in profiles
      await sbClient.from('profiles').insert([
        {
          id: userId,
          name,
          surname,
          business_name: businessName
        }
      ]);

      // Recupera gli ID dei PSP selezionati dalla tabella psp_conditions
      const { data: allPSPs } = await sbClient
        .from('psp_conditions')
        .select('id, psp_name');

      for (const pspName of selectedPSPs) {
        const match = allPSPs.find(p => p.psp_name.toLowerCase() === pspName.toLowerCase());
        if (match) {
          await sbClient.from('user_psp').insert([
            {
              user_id: userId,
              psp_id: match.id,
              attivo: true
            }
          ]);
        }
      }

      alert("Profilo completato e PSP attivati!");
      window.location.href = "/dashboard";
    }

    document.getElementById("user-form").addEventListener("submit", handleUserDataSubmit);
  </script>
</body>
</html>
