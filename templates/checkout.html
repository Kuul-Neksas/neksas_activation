<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout Neks…ôs</title>

  <!-- Font Awesome (icone) - senza integrity per evitare blocchi -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <style>
    body { font-family: 'Poppins', sans-serif; background:#f4f7fa; margin:0; color:#333; }
    .container { max-width:520px; margin:20px auto; padding:20px; background:#fff; border-radius:12px; box-shadow:0 0 10px rgba(0,0,0,0.08); }
    .logo { display:block; margin:0 auto 10px; height:120px; }
    h1 { text-align:center; color:#0077cc; margin-bottom:6px; }
    h2 { text-align:center; color:#555; margin-top:0; margin-bottom:16px; font-weight:400; }
    label { display:block; margin-top:12px; font-weight:600; font-size:0.95em; }
    input[type="text"], input[type="email"], input[type="number"], input[type="password"] {
      width:100%; padding:8px; margin-top:6px; border-radius:6px; border:1px solid #ccc; font-size:0.95em;
    }
    .password-wrapper { position:relative; }
    .toggle-password { position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; font-size:1.05em; color:#555; }
    button.primary { margin-top:14px; padding:10px; background:#0077cc; color:#fff; border:none; border-radius:6px; cursor:pointer; width:100%; }
    button.primary:hover { background:#005fa3; }
    .inline-button { display:inline-block; margin-left:10px; padding:6px 10px; font-size:0.85em; background:#eee; border:none; border-radius:6px; cursor:pointer; }
    .inline-button:hover { background:#ddd; }
    .psp-card { border:1px solid #0077cc; border-radius:8px; padding:10px; margin-top:12px; background:#eef6ff; font-size:0.9em; box-shadow:0 2px 4px rgba(0,0,0,0.04); }
    .psp-card strong { color:#0077cc; }
    .psp-card small { color:#444; display:block; margin-top:6px; }
    .psp-card .pay-btn { margin-top:8px; padding:8px 12px; font-size:0.9em; background:#0077cc; color:#fff; border:none; border-radius:6px; cursor:pointer; }
    .psp-card .pay-btn:hover { background:#005fa3; }
    #qr-container { margin-top:18px; text-align:center; word-break:break-word; }
    .share-icons { margin-top:12px; text-align:center; font-size:1.5em; display:none; }
    .share-icons i { margin:0 12px; cursor:pointer; transition: transform .15s ease; }
    .share-icons i:hover { transform:scale(1.15); }
    .disclaimer { margin-top:20px; font-size:0.9em; color:#666; text-align:center; }
    .muted { color:#777; font-style:italic; font-size:0.9em; }
    .success-msg { margin-top:12px; color:green; font-weight:600; text-align:center; display:none; }
    .error-msg { margin-top:12px; color:#cc0000; font-weight:600; text-align:center; display:none; }
  </style>
</head>
<body>
  <div class="container">
    <img src="/static/logo-neksas.png" alt="Logo Neks…ôs" class="logo" />
    <h1>Checkout</h1>
    <h2>Benvenuto nel servizio dei pagamenti digitali Neks…ôs</h2>

    <!-- LOGIN -->
    <div id="login-section">
      <label for="login-email">Email</label>
      <input type="email" id="login-email" placeholder="tuo@esempio.it"/>

      <label for="login-password">Password</label>
      <div class="password-wrapper">
        <input type="password" id="login-password" placeholder="Password" />
        <span class="toggle-password" id="toggle-eye">üëÅÔ∏è</span>
      </div>

      <button id="login-button" class="primary">Accedi</button>
      <p class="muted" style="text-align:center; margin-top:8px;">Usa le credenziali del prototipo</p>
    </div>

    <!-- CHECKOUT -->
    <div id="checkout-section" style="display:none;">
      <label>Email</label>
      <input type="text" id="email" readonly />

      <label>Attivit√† / Azienda</label>
      <input type="text" id="business" readonly />

      <label>Descrizione (fattura, merce, ecc.)</label>
      <input type="text" id="description" placeholder="Es. Servizio X - fattura #123" />

      <label>Importo (‚Ç¨)</label>
      <div style="display:flex; gap:8px; align-items:center;">
        <input type="number" id="amount" min="0.01" step="0.01" style="flex:1;" />
        <button class="inline-button" id="btn-clear" type="button">Pulisci</button>
      </div>

      <div id="psp-list" style="margin-top:8px;">
        <p class="muted">Inserisci un importo per vedere i PSP disponibili e i costi stimati.</p>
      </div>

      <div id="qr-container"></div>

      <!-- icone condividi -->
      <div class="share-icons" id="share-icons">
        <i class="fas fa-envelope" style="color:#0077cc;" onclick="shareViaEmail()" title="Invia via Email"></i>
        <i class="fab fa-whatsapp" style="color:#25D366;" onclick="shareViaWhatsApp()" title="Condividi su WhatsApp"></i>
        <i class="fas fa-link" style="color:#555;" onclick="copyLink()" title="Copia link"></i>
      </div>

      <div class="success-msg" id="success-msg">Pagamento generato e registrato (prototipo).</div>
      <div class="error-msg" id="error-msg"></div>

      <div class="disclaimer">
        Proseguendo accetti le nostre condizioni. <br />
        <span class="muted">I dati del pagamento non vengono salvati da Neks…ôs, ma solo dal PSP utilizzato.</span>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // --- variabili passate dal render Flask (assicurati siano valorizzate in app.py)
    const supabase = createClient("{{ supabase_url }}", "{{ supabase_key }}");

    // stato
    let currentPaymentLink = "";
    let lastPspList = []; // memorizza pspList recuperati al login
    let currentUserId = null;

    // elementi
    const loginSection = document.getElementById("login-section");
    const checkoutSection = document.getElementById("checkout-section");
    const loginBtn = document.getElementById("login-button");
    const toggleEye = document.getElementById("toggle-eye");
    const pspListEl = document.getElementById("psp-list");
    const qrContainer = document.getElementById("qr-container");
    const shareIcons = document.getElementById("share-icons");
    const btnClear = document.getElementById("btn-clear");
    const successMsg = document.getElementById("success-msg");
    const errorMsg = document.getElementById("error-msg");

    // helper
    function log(...args){ console.log("[checkout]", ...args); }
    function showSuccess(text) { successMsg.textContent = text; successMsg.style.display = "block"; errorMsg.style.display = "none"; }
    function showError(text) { errorMsg.textContent = text; errorMsg.style.display = "block"; successMsg.style.display = "none"; }

    // toggle password visibility
    toggleEye.addEventListener("click", () => {
      const pwd = document.getElementById("login-password");
      pwd.type = pwd.type === "password" ? "text" : "password";
    });

    // clear fields (pulizia completa)
    function clearFields() {
      document.getElementById("description").value = "";
      document.getElementById("amount").value = "";
      pspListEl.innerHTML = '<p class="muted">Inserisci un importo per vedere i PSP disponibili e i costi stimati.</p>';
      qrContainer.innerHTML = "";
      shareIcons.style.display = "none";
      successMsg.style.display = "none";
      errorMsg.style.display = "none";
      currentPaymentLink = "";
    }

    // clear only inputs (usato dopo insert success)
    function clearInputsOnly() {
      document.getElementById("description").value = "";
      document.getElementById("amount").value = "";
    }

    // Evento Pulisci
    btnClear.addEventListener("click", () => {
      clearFields();
    });

    // Login
    loginBtn.addEventListener("click", async () => {
      const email = document.getElementById("login-email").value.trim().toLowerCase();
      const password = document.getElementById("login-password").value.trim();

      if (!email || !password) {
        alert("Inserisci email e password.");
        return;
      }

      log("Tentativo login per", email);
      const { data: user, error } = await supabase
        .from("users")
        .select("*")
        .eq("email", email)
        .eq("password_hash", password)
        .maybeSingle();

      if (error) {
        console.error("Errore query users:", error);
        alert("Errore di sistema.");
        return;
      }
      if (!user) {
        alert("Credenziali non valide.");
        return;
      }

      // successo login
      log("Login riuscito:", user);
      loginSection.style.display = "none";
      checkoutSection.style.display = "block";

      // set UI
      document.getElementById("email").value = user.email;
      document.getElementById("business").value = user.business_name || "-";
      clearFields();

      // recupera user_psp_conditions per il calcolo costi (memorizza in lastPspList)
      const { data: pspList, error: pspErr } = await supabase
        .from("user_psp_conditions")
        .select("*")
        .eq("user_id", user.id);

      if (pspErr) {
        console.error("Errore recupero user_psp_conditions:", pspErr);
        showError("Errore nel caricamento dei PSP.");
        lastPspList = [];
      } else {
        log("PSP recuperati:", pspList?.length || 0);
        lastPspList = pspList || [];
      }

      currentUserId = user.id;

      // aggiungi listener per l'input dell'importo
      const amountInput = document.getElementById("amount");
      amountInput.addEventListener("input", () => renderPSPCards(lastPspList, currentUserId));
    });

    // render PSP cards con costo stimato (come prima)
    function renderPSPCards(pspList, userId) {
      const amountRaw = document.getElementById("amount").value;
      const amount = parseFloat(amountRaw);
      const description = document.getElementById("description").value.trim();
      pspListEl.innerHTML = "";

      if (!amount || amount <= 0) {
        pspListEl.innerHTML = '<p class="muted">Inserisci un importo per vedere i PSP disponibili e i costi stimati.</p>';
        return;
      }

      const sorted = [...pspList].map(psp => {
        const fixed = parseFloat(psp.fixed_fee || 0);
        const pct = parseFloat(psp.percentage_fee || 0);
        const cost = fixed + (amount * pct / 100);
        return { ...psp, cost };
      }).sort((a,b) => a.cost - b.cost);

      sorted.forEach((psp, idx) => {
        const card = document.createElement("div");
        card.className = "psp-card";
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <strong>${psp.circuit_name}</strong>
            ${idx === 0 ? '<span style="color:green;">‚úÖ Consigliato</span>' : ''}
          </div>
          <small>Fee fissa: ${psp.fixed_fee ?? "-"} ${psp.currency ?? "EUR"}</small>
          <small>Fee %: ${psp.percentage_fee ?? "-"}%</small>
          <div style="margin-top:8px;"><strong>Costo stimato: ‚Ç¨${(psp.cost || 0).toFixed(2)}</strong></div>
          <div style="text-align:right; margin-top:8px;">
            <button class="pay-btn" type="button">Genera pagamento</button>
          </div>
        `;
        // associa evento pay
        card.querySelector("button").onclick = () => handlePayment(psp, amount, description, userId);
        pspListEl.appendChild(card);
      });
    }

    // genera link + qr + insert transaction; pulisce inputs SOLO se insert OK
    async function handlePayment(psp, amount, description, userId) {
      log("Generazione pagamento per", psp.circuit_name, "amount", amount);
      const link = generatePaymentLink(psp.circuit_name, amount, description);
      currentPaymentLink = link;

      // mostra QR + link
      qrContainer.innerHTML = `<p>Scansiona per pagare con ${psp.circuit_name}:</p><canvas id="qr"></canvas><p style="word-break:break-all;"><a href="${link}" target="_blank" rel="noopener">${link}</a></p>`;
      try {
        await QRCode.toCanvas(document.getElementById("qr"), link);
      } catch (e) {
        console.error("Errore generazione QR:", e);
      }

      // mostra icone di condivisione (ma non pulire ancora)
      shareIcons.style.display = "block";

      // inserisci transazione (consideriamo l'insert come esito "locale" OK per il prototipo)
      try {
        const toInsert = {
          user_id: userId,
          psp_id: psp.psp_id || psp.id,
          amount,
          currency: psp.currency || 'EUR',
          created_at: new Date().toISOString()
        };
        log("Insert transaction:", toInsert);
        const { data: inserted, error: txErr } = await supabase.from("transactions").insert([toInsert]).select();
        if (txErr) {
          console.error("Errore insert transaction:", txErr);
          showError("Errore nel registrare la transazione (prototipo).");
          return;
        }
        log("Transazione registrata:", inserted);
        showSuccess("Pagamento generato e registrato (prototipo).");

        // pulisci i campi di input SOLO dopo insert OK (descrizione e importo)
        clearInputsOnly();

      } catch (err) {
        console.error("Errore insert transactions (catch):", err);
        showError("Errore durante la registrazione della transazione.");
      }
    }

    function generatePaymentLink(pspName, amount, description) {
      const encodedDesc = encodeURIComponent(description || '');
      if (!pspName) pspName = 'psp';
      if (pspName.toLowerCase() === "stripe") {
        return `https://checkout.stripe.com/pay/test?amount=${amount}&desc=${encodedDesc}`;
      } else if (pspName.toLowerCase() === "paypal") {
        return `https://www.paypal.com/pay?amount=${amount}&desc=${encodedDesc}`;
      } else {
        return `https://neksas-activation.onrender.com/pay?psp=${encodeURIComponent(pspName)}&amount=${amount}&desc=${encodedDesc}`;
      }
    }

    // condivisione
    window.shareViaEmail = function () {
      if (!currentPaymentLink) return alert("Genera prima il pagamento.");
      const subject = encodeURIComponent("Pagamento Neks…ôs");
      const body = encodeURIComponent(`Ecco il link per completare il pagamento:\n${currentPaymentLink}`);
      window.open(`mailto:?subject=${subject}&body=${body}`);
    };

    window.shareViaWhatsApp = function () {
      if (!currentPaymentLink) return alert("Genera prima il pagamento.");
      const text = encodeURIComponent(`Ecco il link per completare il pagamento:\n${currentPaymentLink}`);
      window.open(`https://wa.me/?text=${text}`, "_blank");
    };

    window.copyLink = function () {
      if (!currentPaymentLink) return alert("Genera prima il pagamento.");
      navigator.clipboard.writeText(currentPaymentLink)
        .then(()=> alert("Link copiato negli appunti."))
        .catch(()=> alert("Errore nella copia del link."));
    };

    // pulizia iniziale quando si apre la pagina
    window.addEventListener("load", () => {
      try {
        clearFields();
        log("Pagina caricata: campi puliti.");
      } catch(e){ console.warn("load clearFields error", e); }
    });
  </script>
</body>
</html>











