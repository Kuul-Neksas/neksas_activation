<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout Neks…ôs</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body { font-family: 'Poppins', sans-serif; background-color: #f4f7fa; margin: 0; padding: 0; color: #333; }
    .container { max-width: 500px; margin: 20px auto; padding: 20px; background: #fff; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h1 { text-align: center; color: #0077cc; margin-bottom: 5px; }
    h2 { text-align: center; font-size: 1em; font-weight: normal; color: #555; margin-top: 0; margin-bottom: 20px; }
    .logo { display: block; margin: 0 auto 10px; height: 180px; }
    label { display: block; margin-top: 12px; font-weight: bold; font-size: 0.95em; }
    input { width: 100%; padding: 8px; margin-top: 5px; border-radius: 6px; border: 1px solid #ccc; font-size: 0.95em; }
    input[readonly] { background-color: #f0f0f0; cursor: not-allowed; }
    .password-wrapper { position: relative; }
    .toggle-password { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1.1em; color: #555; }
    button { margin-top: 15px; padding: 10px; background-color: #0077cc; color: white; border: none; border-radius: 6px; cursor: pointer; width: 100%; }
    button:hover { background-color: #005fa3; }
    .psp-card { border: 1px solid #0077cc; border-radius: 8px; padding: 8px; margin-top: 12px; background-color: #eef6ff; font-size: 0.9em; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .psp-card strong { font-size: 1em; color: #0077cc; }
    .psp-card button { margin-top: 8px; padding: 8px; font-size: 0.9em; background-color: #0077cc; color: white; border: none; border-radius: 6px; cursor: pointer; }
    .psp-card button:hover { background-color: #005fa3; }
    #qr-container { margin-top: 20px; text-align: center; word-break: break-word; }
    .share-icons { margin-top: 10px; text-align: center; font-size: 1.5em; }
    .share-icons span { margin: 0 10px; cursor: pointer; }
    .disclaimer { margin-top: 30px; font-size: 0.9em; color: #666; text-align: center; }
    .highlight { font-weight: bold; color: #cc0000; }
    .inline-button { display: inline-block; margin-left: 10px; padding: 6px 10px; font-size: 0.8em; background-color: #ccc; border: none; border-radius: 4px; cursor: pointer; }
    .inline-button:hover { background-color: #aaa; }
    a.payment-hidden { color: #0077cc; text-decoration: underline; cursor: pointer; }
    #payment-status { margin-top: 10px; font-weight: bold; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <img src="/static/logo-neksas.png" alt="Logo Neks…ôs" class="logo" />
    <h1>Checkout</h1>
    <h2>Benvenuto nel servizio dei pagamenti digitali Neks…ôs</h2>

    <div id="login-section">
      <label>Email</label>
      <input type="email" id="login-email" />

      <label>Password</label>
      <div class="password-wrapper">
        <input type="password" id="login-password" />
        <span class="toggle-password" id="toggle-eye">üëÅÔ∏è</span>
      </div>

      <button id="login-button">Accedi</button>
    </div>

    <div id="checkout-section" style="display:none;">
      <label>Email</label>
      <input type="text" id="email" readonly />

      <label>Attivit√† / Azienda</label>
      <input type="text" id="business" readonly />

      <label>Descrizione (fattura, merce, ecc.)</label>
      <input type="text" id="description" />

      <label>Importo (‚Ç¨)</label>
      <input type="number" id="amount" min="0.01" step="0.01" />
      <button class="inline-button" onclick="clearFields()">Pulisci</button>

      <div id="psp-list"></div>
      <div id="qr-container"></div>

      <!-- Pulsante Verifica Pagamento -->
      <p style="text-align:center; margin-top:10px;">
        <button id="verify-payment" style="display:none;">Verifica Pagamento</button>
      </p>

      <div class="share-icons" id="share-icons" style="display:none;">
        <span onclick="shareViaEmail()" title="Invia via Email">
          <i class="fas fa-envelope" style="color:#0077cc;"></i>
        </span>
        <span onclick="shareViaWhatsApp()" title="Condividi su WhatsApp">
          <i class="fab fa-whatsapp" style="color:#25D366;"></i>
        </span>
        <span onclick="copyLink()" title="Copia link">
          <i class="fas fa-link" style="color:#555;"></i>
        </span>
      </div>

      <div class="disclaimer">
        <div id="payment-status"></div>
        Proseguendo accetti le nostre condizioni. <br />
        <span class="highlight">I dati del pagamento non vengono salvati da Neks…ôs, ma solo dal PSP utilizzato.</span>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient("{{ supabase_url }}", "{{ supabase_key }}");
    let currentPaymentLink = "";
    let lastTransactionId = null; // nuova variabile per verificare pagamento

    document.getElementById("toggle-eye").addEventListener("click", () => {
      const input = document.getElementById("login-password");
      input.type = input.type === "password" ? "text" : "password";
    });

    document.getElementById("login-button").onclick = async () => {
      const email = document.getElementById("login-email").value.trim().toLowerCase();
      const password = document.getElementById("login-password").value.trim();

      const { data: user, error: userErr } = await supabase
        .from("users")
        .select("*")
        .eq("email", email)
        .eq("password_hash", password)
        .maybeSingle();

      if (userErr || !user) {
        alert("Credenziali non valide.");
        return;
      }

      document.getElementById("login-section").style.display = "none";
      document.getElementById("checkout-section").style.display = "block";

      document.getElementById("email").value = user.email;
      document.getElementById("business").value = user.business_name || "-";
      clearFields();

      const { data: pspList, error: pspErr } = await supabase
        .from("user_psp_conditions")
        .select("*")
        .eq("user_id", user.id);

      if (pspErr) console.error("Errore recupero PSP:", pspErr);

      document.getElementById("amount").addEventListener("input", () =>
        renderPSPCards(pspList || [], user.id)
      );
    };

    window.clearFields = function () {
      document.getElementById("description").value = "";
      document.getElementById("amount").value = "";
      document.getElementById("psp-list").innerHTML = "";
      document.getElementById("qr-container").innerHTML = "";
      document.getElementById("share-icons").style.display = "none";
      document.getElementById("verify-payment").style.display = "none";
      document.getElementById("payment-status").innerText = "";
      document.getElementById("payment-status").style.color = "green";
      currentPaymentLink = "";
      lastTransactionId = null;
    }

    function renderPSPCards(pspList, userId) {
      const amount = parseFloat(document.getElementById("amount").value);
      const description = document.getElementById("description").value.trim();
      const business = document.getElementById("business").value.trim();
      const container = document.getElementById("psp-list");
      container.innerHTML = "";

      if (!amount || amount <= 0) return;

      const sorted = [...pspList].map(psp => {
        const cost = parseFloat(psp.fixed_fee || 0) + (amount * parseFloat(psp.percentage_fee || 0) / 100);
        return { ...psp, cost };
      }).sort((a, b) => a.cost - b.cost);

      sorted.forEach((psp, index) => {
        const card = document.createElement("div");
        card.className = "psp-card";
        card.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <strong>${psp.circuit_name}</strong>
            ${index === 0 ? '<span style="color:green;">‚úÖ Consigliato</span>' : ''}
          </div>
          <div>üí∂ Fee fissa: ${psp.fixed_fee ?? "-"} ${psp.currency}</div>
          <div>üìä Fee %: ${psp.percentage_fee ?? "-"}%</div>
          <div>üí∞ Costo stimato per il PSP: <strong>‚Ç¨${psp.cost.toFixed(2)}</strong></div>
          <button>Genera pagamento</button>
        `;
        card.querySelector("button").onclick = () =>
          handlePayment(psp, amount, description, business, userId);
        container.appendChild(card);
      });
    }

    // 1Ô∏è‚É£ Genera pagamento e salva transazione
async function handlePayment(psp, amount, description, business, userId) {
  const statusBox = document.getElementById("payment-status");
  statusBox.innerText = "";

  try {
    // Inserimento transazione base
    const { data, error } = await supabase
      .from("transactions")
      .insert([{ user_id: userId, psp_id: psp.psp_id, amount, currency: "EUR", status: "pending", created_at: new Date().toISOString() }])
      .select("id")
      .single();

    if (error) throw error;

    lastTransactionId = data.id; // salvo l'id per la verifica

    // Genera link/QR come prima
    const url = `/simulate-pay?psp=${encodeURIComponent(psp.circuit_name)}&amount=${encodeURIComponent(amount)}&desc=${encodeURIComponent(description)}&business=${encodeURIComponent(business)}&user_id=${encodeURIComponent(userId)}&transaction_id=${data.id}`;
    currentPaymentLink = new URL(url, window.location.origin).href;
    document.getElementById("qr-container").innerHTML = `
      <p>Scansiona per pagare con ${psp.circuit_name}:</p>
      <canvas id="qr"></canvas>
      <p><a class="payment-hidden" href="${currentPaymentLink}" target="_blank">Vai al pagamento</a></p>
    `;
    QRCode.toCanvas(document.getElementById("qr"), currentPaymentLink);
    document.getElementById("verify-payment").style.display = "inline-block";

  } catch (err) {
    statusBox.innerText = "‚ùå Errore nella registrazione: " + err.message;
    statusBox.style.color = "red";
  }
}

// 2Ô∏è‚É£ Verifica pagamento semplice
async function verifyPayment() {
  if (!lastTransactionId) return;

  const statusBox = document.getElementById("payment-status");
  statusBox.innerText = "";

  try {
    const { data, error } = await supabase
      .from("transactions")
      .select("status")
      .eq("id", lastTransactionId)
      .maybeSingle();

    if (error) throw error;
    if (!data) {
      statusBox.innerText = "‚ùå Transazione non trovata.";
      statusBox.style.color = "red";
      return;
    }

    if (data.status === "ok") {
      statusBox.innerText = "‚úÖ Pagamento completato!";
      statusBox.style.color = "green";
    } else if (data.status === "failed") {
      statusBox.innerText = "‚ùå Pagamento fallito.";
      statusBox.style.color = "red";
    } else {
      statusBox.innerText = "‚è≥ Pagamento ancora in sospeso‚Ä¶";
      statusBox.style.color = "orange";
    }
  } catch (err) {
    statusBox.innerText = "‚ùå Errore nella verifica: " + err.message;
    statusBox.style.color = "red";
  }
}

document.getElementById("verify-payment").onclick = verifyPayment;


    window.shareViaEmail = function () {
      const subject = encodeURIComponent("Pagamento Neks…ôs");
      const body = encodeURIComponent(`Ecco il link per completare il pagamento:\n${currentPaymentLink}`);
      window.open(`mailto:?subject=${subject}&body=${body}`);
    };

    window.shareViaWhatsApp = function () {
      const text = encodeURIComponent(`Ecco il link per completare il pagamento:\n${currentPaymentLink}`);
      window.open(`https://wa.me/?text=${text}`);
    };

    window.copyLink = function () {
      navigator.clipboard.writeText(currentPaymentLink)
        .then(() => alert("Link copiato negli appunti."))
        .catch(() => alert("Errore nella copia del link."));
    };
  </script>
</body>
</html>
